{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nvar __jsx = React.createElement;\n\nfunction _createSuper(Derived) { return function () { var Super = _getPrototypeOf(Derived), result; if (_isNativeReflectConstruct()) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nimport Participant from \"./Participant\";\nimport React from \"react\";\nimport VideoCall from \"../helpers/simple-peer\";\nimport create from \"@ant-design/icons/lib/components/IconFont\";\nimport { getDisplayStream } from \"../helpers/media-access\";\n\nvar io = require(\"socket.io-client\");\n\nvar socket = io(process.env.reactAppSignalingServer);\n\nvar Room = /*#__PURE__*/function (_React$Component) {\n  _inherits(Room, _React$Component);\n\n  var _super = _createSuper(Room);\n\n  function Room() {\n    var _this;\n\n    _classCallCheck(this, Room);\n\n    _this = _super.call(this);\n\n    _defineProperty(_assertThisInitialized(_this), \"videoCall\", new VideoCall());\n\n    _defineProperty(_assertThisInitialized(_this), \"enter\", function (roomId) {\n      console.log(\"enter in \" + roomId);\n\n      _this.setState({\n        connecting: true\n      });\n\n      var peer = _this.videoCall.init(_this.state.localStream, _this.state.initiator);\n\n      _this.setState({\n        peer: peer\n      });\n\n      _this.state.peerIds.push(peer._id);\n\n      peer.on(\"signal\", function (data) {\n        console.log(\"signal peer\");\n        var signal = {\n          room: roomId,\n          desc: data\n        };\n\n        _this.state.socket.emit(\"signal\", signal);\n      });\n      peer.on(\"stream\", function (stream) {\n        console.log(\"stream peer\");\n        _this.remoteVideo.srcObject = stream;\n\n        _this.setState({\n          connecting: false,\n          waiting: false\n        });\n      });\n      peer.on(\"error\", function (err) {\n        console.log(err);\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"call\", function (otherId) {\n      console.log(\"callllllll\");\n\n      _this.videoCall.connect(otherId);\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"renderFull\", function () {\n      if (_this.state.full) {\n        return \"The room is full\";\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"disableVideo\", function () {\n      var videoTrack = localStream.getVideoTracks()[0];\n\n      if (localStream) {\n        videoTrack.enabled = false;\n\n        _this.setState({\n          videoEnabled: false\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"enableVideo\", function () {\n      var videoTrack = localStream.getVideoTracks()[0];\n\n      if (localStream) {\n        videoTrack.enabled = true;\n\n        _this.setState({\n          videoEnabled: true\n        });\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"setAudioEnabled\", function (bool) {\n      _this.setState({\n        audioEnabled: bool\n      });\n    });\n\n    _this.state = {\n      localStream: {},\n      remoteStreamUrl: \"\",\n      streamUrl: \"\",\n      initiator: false,\n      peer: {},\n      full: false,\n      connecting: false,\n      waiting: true,\n      peerIds: [],\n      audioEnabled: false,\n      videoEnabled: true\n    };\n    return _this;\n  }\n\n  _createClass(Room, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      console.log(process.env.REACT_APP_SIGNALING_SERVER);\n      var socket = io(process.env.REACT_APP_SIGNALING_SERVER);\n      var component = this;\n      this.setState({\n        socket: socket\n      });\n      var roomId = this.props.roomId;\n      this.getUserMedia().then(function () {\n        socket.emit(\"join\", {\n          roomId: roomId\n        });\n      });\n      socket.on(\"init\", function () {\n        component.setState({\n          initiator: true\n        });\n      });\n      socket.on(\"ready\", function () {\n        console.log(\"c'est ok on rentre dans \" + roomId);\n        component.enter(roomId);\n      });\n      socket.on(\"desc\", function (data) {\n        console.log(data);\n        console.log(data.type === \"offer\" && component.state.initiator);\n        console.log(data.type === \"answer\" && !component.state.initiator);\n        if (data.type === \"offer\" && component.state.initiator) return;\n        if (data.type === \"answer\" && !component.state.initiator) return;\n        console.log(\"ok on appelle\");\n        if (component.state.connecting) component.call(data);\n      });\n      socket.on(\"disconnected\", function () {\n        console.log(\"il est parti\");\n        component.setState({\n          initiator: true\n        });\n      });\n      socket.on(\"full\", function () {\n        console.log(\"c'est plein\");\n        component.setState({\n          full: true\n        });\n      });\n    }\n  }, {\n    key: \"getUserMedia\",\n    value: function getUserMedia(cb) {\n      var _this2 = this;\n\n      return new Promise(function (resolve, reject) {\n        navigator.getUserMedia = navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;\n        var op = {\n          video: {\n            width: {\n              min: 160,\n              ideal: 640,\n              max: 1280\n            },\n            height: {\n              min: 120,\n              ideal: 360,\n              max: 720\n            }\n          },\n          audio: true\n        };\n        navigator.getUserMedia(op, function (stream) {\n          _this2.setState({\n            streamUrl: stream,\n            localStream: stream\n          });\n\n          _this2.localVideo.srcObject = stream;\n          resolve();\n        }, function () {});\n      });\n    }\n  }, {\n    key: \"getDisplay\",\n    value: function getDisplay() {\n      var _this3 = this;\n\n      getDisplayStream().then(function (stream) {\n        stream.oninactive = function () {\n          _this3.state.peer.removeStream(_this3.state.localStream);\n\n          _this3.getUserMedia().then(function () {\n            _this3.state.peer.addStream(_this3.state.localStream);\n          });\n        };\n\n        _this3.setState({\n          streamUrl: stream,\n          localStream: stream\n        });\n\n        _this3.localVideo.srcObject = stream;\n\n        _this3.state.peer.addStream(stream);\n      });\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this4 = this;\n\n      console.log(this.state.peerIds);\n      var _this$props = this.props,\n          username = _this$props.username,\n          roomId = _this$props.roomId;\n      var _this$state = this.state,\n          connecting = _this$state.connecting,\n          waiting = _this$state.waiting,\n          localStream = _this$state.localStream,\n          audioEnabled = _this$state.audioEnabled,\n          videoEnabled = _this$state.videoEnabled;\n      return __jsx(\"div\", {\n        className: \"room\"\n      }, __jsx(\"h2\", null, \"Salle: \", roomId), connecting && __jsx(\"div\", null, __jsx(\"p\", null, \"Establishing connection...\")), waiting && __jsx(\"div\", null, __jsx(\"p\", null, \"Waiting for someone...\")), __jsx(Participant, {\n        isLocal: false,\n        video: __jsx(\"div\", null, __jsx(\"video\", {\n          autoPlay: true,\n          id: \"remoteVideo\",\n          ref: function ref(video) {\n            return _this4.remoteVideo = video;\n          }\n        }))\n      }), __jsx(\"div\", {\n        className: \"local-participant\"\n      }, localStream !== undefined ? __jsx(Participant, {\n        isLocal: true,\n        key: \"fneoisfnoes\",\n        name: username,\n        video: __jsx(\"div\", null, __jsx(\"video\", {\n          autoPlay: true,\n          id: \"localVideo\",\n          muted: true,\n          ref: function ref(video) {\n            return _this4.localVideo = video;\n          }\n        })),\n        setAudioEnabled: this.setAudioEnabled,\n        audioEnabled: audioEnabled,\n        disableVideo: this.disableVideo,\n        enableVideo: this.enableVideo,\n        videoEnabled: videoEnabled\n      }) : \"\"));\n    }\n  }]);\n\n  return Room;\n}(React.Component);\n\nexport default Room;","map":{"version":3,"sources":["/Users/julienjuge/DEVPERSO/video-chat/components/Room.js"],"names":["Participant","React","VideoCall","create","getDisplayStream","io","require","socket","process","env","reactAppSignalingServer","Room","roomId","console","log","setState","connecting","peer","videoCall","init","state","localStream","initiator","peerIds","push","_id","on","data","signal","room","desc","emit","stream","remoteVideo","srcObject","waiting","err","otherId","connect","full","videoTrack","getVideoTracks","enabled","videoEnabled","bool","audioEnabled","remoteStreamUrl","streamUrl","REACT_APP_SIGNALING_SERVER","component","props","getUserMedia","then","enter","type","call","cb","Promise","resolve","reject","navigator","webkitGetUserMedia","mozGetUserMedia","op","video","width","min","ideal","max","height","audio","localVideo","oninactive","removeStream","addStream","username","undefined","setAudioEnabled","disableVideo","enableVideo","Component"],"mappings":";;;;;;;;;;;;;AAAA,OAAOA,WAAP,MAAwB,eAAxB;AACA,OAAOC,KAAP,MAAkB,OAAlB;AACA,OAAOC,SAAP,MAAsB,wBAAtB;AACA,OAAOC,MAAP,MAAmB,2CAAnB;AACA,SAASC,gBAAT,QAAiC,yBAAjC;;AAEA,IAAMC,EAAE,GAAGC,OAAO,CAAC,kBAAD,CAAlB;;AACA,IAAMC,MAAM,GAAGF,EAAE,CAACG,OAAO,CAACC,GAAR,CAAYC,uBAAb,CAAjB;;IAEMC,I;;;;;AACJ,kBAAc;AAAA;;AAAA;;AACZ;;AADY,gEAgBF,IAAIT,SAAJ,EAhBE;;AAAA,4DAwFN,UAAAU,MAAM,EAAI;AAChBC,MAAAA,OAAO,CAACC,GAAR,CAAY,cAAcF,MAA1B;;AACA,YAAKG,QAAL,CAAc;AAAEC,QAAAA,UAAU,EAAE;AAAd,OAAd;;AACA,UAAMC,IAAI,GAAG,MAAKC,SAAL,CAAeC,IAAf,CACX,MAAKC,KAAL,CAAWC,WADA,EAEX,MAAKD,KAAL,CAAWE,SAFA,CAAb;;AAIA,YAAKP,QAAL,CAAc;AAAEE,QAAAA,IAAI,EAAJA;AAAF,OAAd;;AACA,YAAKG,KAAL,CAAWG,OAAX,CAAmBC,IAAnB,CAAwBP,IAAI,CAACQ,GAA7B;;AAEAR,MAAAA,IAAI,CAACS,EAAL,CAAQ,QAAR,EAAkB,UAAAC,IAAI,EAAI;AACxBd,QAAAA,OAAO,CAACC,GAAR,CAAY,aAAZ;AACA,YAAMc,MAAM,GAAG;AACbC,UAAAA,IAAI,EAAEjB,MADO;AAEbkB,UAAAA,IAAI,EAAEH;AAFO,SAAf;;AAIA,cAAKP,KAAL,CAAWb,MAAX,CAAkBwB,IAAlB,CAAuB,QAAvB,EAAiCH,MAAjC;AACD,OAPD;AAQAX,MAAAA,IAAI,CAACS,EAAL,CAAQ,QAAR,EAAkB,UAAAM,MAAM,EAAI;AAC1BnB,QAAAA,OAAO,CAACC,GAAR,CAAY,aAAZ;AACA,cAAKmB,WAAL,CAAiBC,SAAjB,GAA6BF,MAA7B;;AACA,cAAKjB,QAAL,CAAc;AAAEC,UAAAA,UAAU,EAAE,KAAd;AAAqBmB,UAAAA,OAAO,EAAE;AAA9B,SAAd;AACD,OAJD;AAKAlB,MAAAA,IAAI,CAACS,EAAL,CAAQ,OAAR,EAAiB,UAASU,GAAT,EAAc;AAC7BvB,QAAAA,OAAO,CAACC,GAAR,CAAYsB,GAAZ;AACD,OAFD;AAGD,KAlHa;;AAAA,2DAmHP,UAAAC,OAAO,EAAI;AAChBxB,MAAAA,OAAO,CAACC,GAAR,CAAY,YAAZ;;AACA,YAAKI,SAAL,CAAeoB,OAAf,CAAuBD,OAAvB;AACD,KAtHa;;AAAA,iEAuHD,YAAM;AACjB,UAAI,MAAKjB,KAAL,CAAWmB,IAAf,EAAqB;AACnB,eAAO,kBAAP;AACD;AACF,KA3Ha;;AAAA,mEA6HC,YAAM;AACnB,UAAMC,UAAU,GAAGnB,WAAW,CAACoB,cAAZ,GAA6B,CAA7B,CAAnB;;AAEA,UAAIpB,WAAJ,EAAiB;AACfmB,QAAAA,UAAU,CAACE,OAAX,GAAqB,KAArB;;AACA,cAAK3B,QAAL,CAAc;AAAE4B,UAAAA,YAAY,EAAE;AAAhB,SAAd;AACD;AACF,KApIa;;AAAA,kEAsIA,YAAM;AAClB,UAAMH,UAAU,GAAGnB,WAAW,CAACoB,cAAZ,GAA6B,CAA7B,CAAnB;;AAEA,UAAIpB,WAAJ,EAAiB;AACfmB,QAAAA,UAAU,CAACE,OAAX,GAAqB,IAArB;;AACA,cAAK3B,QAAL,CAAc;AAAE4B,UAAAA,YAAY,EAAE;AAAhB,SAAd;AACD;AACF,KA7Ia;;AAAA,sEA+II,UAAAC,IAAI,EAAI;AACxB,YAAK7B,QAAL,CAAc;AAAE8B,QAAAA,YAAY,EAAED;AAAhB,OAAd;AACD,KAjJa;;AAEZ,UAAKxB,KAAL,GAAa;AACXC,MAAAA,WAAW,EAAE,EADF;AAEXyB,MAAAA,eAAe,EAAE,EAFN;AAGXC,MAAAA,SAAS,EAAE,EAHA;AAIXzB,MAAAA,SAAS,EAAE,KAJA;AAKXL,MAAAA,IAAI,EAAE,EALK;AAMXsB,MAAAA,IAAI,EAAE,KANK;AAOXvB,MAAAA,UAAU,EAAE,KAPD;AAQXmB,MAAAA,OAAO,EAAE,IARE;AASXZ,MAAAA,OAAO,EAAE,EATE;AAUXsB,MAAAA,YAAY,EAAE,KAVH;AAWXF,MAAAA,YAAY,EAAE;AAXH,KAAb;AAFY;AAeb;;;;wCAEmB;AAClB9B,MAAAA,OAAO,CAACC,GAAR,CAAYN,OAAO,CAACC,GAAR,CAAYuC,0BAAxB;AACA,UAAMzC,MAAM,GAAGF,EAAE,CAACG,OAAO,CAACC,GAAR,CAAYuC,0BAAb,CAAjB;AACA,UAAMC,SAAS,GAAG,IAAlB;AACA,WAAKlC,QAAL,CAAc;AAAER,QAAAA,MAAM,EAANA;AAAF,OAAd;AAJkB,UAKVK,MALU,GAKC,KAAKsC,KALN,CAKVtC,MALU;AAMlB,WAAKuC,YAAL,GAAoBC,IAApB,CAAyB,YAAM;AAC7B7C,QAAAA,MAAM,CAACwB,IAAP,CAAY,MAAZ,EAAoB;AAAEnB,UAAAA,MAAM,EAAEA;AAAV,SAApB;AACD,OAFD;AAGAL,MAAAA,MAAM,CAACmB,EAAP,CAAU,MAAV,EAAkB,YAAM;AACtBuB,QAAAA,SAAS,CAAClC,QAAV,CAAmB;AAAEO,UAAAA,SAAS,EAAE;AAAb,SAAnB;AACD,OAFD;AAGAf,MAAAA,MAAM,CAACmB,EAAP,CAAU,OAAV,EAAmB,YAAM;AACvBb,QAAAA,OAAO,CAACC,GAAR,CAAY,6BAA6BF,MAAzC;AACAqC,QAAAA,SAAS,CAACI,KAAV,CAAgBzC,MAAhB;AACD,OAHD;AAIAL,MAAAA,MAAM,CAACmB,EAAP,CAAU,MAAV,EAAkB,UAAAC,IAAI,EAAI;AACxBd,QAAAA,OAAO,CAACC,GAAR,CAAYa,IAAZ;AACAd,QAAAA,OAAO,CAACC,GAAR,CAAYa,IAAI,CAAC2B,IAAL,KAAc,OAAd,IAAyBL,SAAS,CAAC7B,KAAV,CAAgBE,SAArD;AACAT,QAAAA,OAAO,CAACC,GAAR,CAAYa,IAAI,CAAC2B,IAAL,KAAc,QAAd,IAA0B,CAACL,SAAS,CAAC7B,KAAV,CAAgBE,SAAvD;AACA,YAAIK,IAAI,CAAC2B,IAAL,KAAc,OAAd,IAAyBL,SAAS,CAAC7B,KAAV,CAAgBE,SAA7C,EAAwD;AACxD,YAAIK,IAAI,CAAC2B,IAAL,KAAc,QAAd,IAA0B,CAACL,SAAS,CAAC7B,KAAV,CAAgBE,SAA/C,EAA0D;AAC1DT,QAAAA,OAAO,CAACC,GAAR,CAAY,eAAZ;AACA,YAAImC,SAAS,CAAC7B,KAAV,CAAgBJ,UAApB,EAAgCiC,SAAS,CAACM,IAAV,CAAe5B,IAAf;AACjC,OARD;AASApB,MAAAA,MAAM,CAACmB,EAAP,CAAU,cAAV,EAA0B,YAAM;AAC9Bb,QAAAA,OAAO,CAACC,GAAR,CAAY,cAAZ;AACAmC,QAAAA,SAAS,CAAClC,QAAV,CAAmB;AAAEO,UAAAA,SAAS,EAAE;AAAb,SAAnB;AACD,OAHD;AAIAf,MAAAA,MAAM,CAACmB,EAAP,CAAU,MAAV,EAAkB,YAAM;AACtBb,QAAAA,OAAO,CAACC,GAAR,CAAY,aAAZ;AACAmC,QAAAA,SAAS,CAAClC,QAAV,CAAmB;AAAEwB,UAAAA,IAAI,EAAE;AAAR,SAAnB;AACD,OAHD;AAID;;;iCACYiB,E,EAAI;AAAA;;AACf,aAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtCC,QAAAA,SAAS,CAACT,YAAV,GAAyBS,SAAS,CAACT,YAAV,GACvBS,SAAS,CAACT,YAAV,IACAS,SAAS,CAACC,kBADV,IAEAD,SAAS,CAACE,eAHZ;AAIA,YAAMC,EAAE,GAAG;AACTC,UAAAA,KAAK,EAAE;AACLC,YAAAA,KAAK,EAAE;AAAEC,cAAAA,GAAG,EAAE,GAAP;AAAYC,cAAAA,KAAK,EAAE,GAAnB;AAAwBC,cAAAA,GAAG,EAAE;AAA7B,aADF;AAELC,YAAAA,MAAM,EAAE;AAAEH,cAAAA,GAAG,EAAE,GAAP;AAAYC,cAAAA,KAAK,EAAE,GAAnB;AAAwBC,cAAAA,GAAG,EAAE;AAA7B;AAFH,WADE;AAKTE,UAAAA,KAAK,EAAE;AALE,SAAX;AAOAV,QAAAA,SAAS,CAACT,YAAV,CACEY,EADF,EAEE,UAAA/B,MAAM,EAAI;AACR,UAAA,MAAI,CAACjB,QAAL,CAAc;AAAEgC,YAAAA,SAAS,EAAEf,MAAb;AAAqBX,YAAAA,WAAW,EAAEW;AAAlC,WAAd;;AACA,UAAA,MAAI,CAACuC,UAAL,CAAgBrC,SAAhB,GAA4BF,MAA5B;AACA0B,UAAAA,OAAO;AACR,SANH,EAOE,YAAM,CAAE,CAPV;AASD,OArBM,CAAP;AAsBD;;;iCACY;AAAA;;AACXtD,MAAAA,gBAAgB,GAAGgD,IAAnB,CAAwB,UAAApB,MAAM,EAAI;AAChCA,QAAAA,MAAM,CAACwC,UAAP,GAAoB,YAAM;AACxB,UAAA,MAAI,CAACpD,KAAL,CAAWH,IAAX,CAAgBwD,YAAhB,CAA6B,MAAI,CAACrD,KAAL,CAAWC,WAAxC;;AACA,UAAA,MAAI,CAAC8B,YAAL,GAAoBC,IAApB,CAAyB,YAAM;AAC7B,YAAA,MAAI,CAAChC,KAAL,CAAWH,IAAX,CAAgByD,SAAhB,CAA0B,MAAI,CAACtD,KAAL,CAAWC,WAArC;AACD,WAFD;AAGD,SALD;;AAMA,QAAA,MAAI,CAACN,QAAL,CAAc;AAAEgC,UAAAA,SAAS,EAAEf,MAAb;AAAqBX,UAAAA,WAAW,EAAEW;AAAlC,SAAd;;AACA,QAAA,MAAI,CAACuC,UAAL,CAAgBrC,SAAhB,GAA4BF,MAA5B;;AACA,QAAA,MAAI,CAACZ,KAAL,CAAWH,IAAX,CAAgByD,SAAhB,CAA0B1C,MAA1B;AACD,OAVD;AAWD;;;6BA4DQ;AAAA;;AACPnB,MAAAA,OAAO,CAACC,GAAR,CAAY,KAAKM,KAAL,CAAWG,OAAvB;AADO,wBAEsB,KAAK2B,KAF3B;AAAA,UAECyB,QAFD,eAECA,QAFD;AAAA,UAEW/D,MAFX,eAEWA,MAFX;AAAA,wBASH,KAAKQ,KATF;AAAA,UAILJ,UAJK,eAILA,UAJK;AAAA,UAKLmB,OALK,eAKLA,OALK;AAAA,UAMLd,WANK,eAMLA,WANK;AAAA,UAOLwB,YAPK,eAOLA,YAPK;AAAA,UAQLF,YARK,eAQLA,YARK;AAUP,aACE;AAAK,QAAA,SAAS,EAAC;AAAf,SACE,6BAAY/B,MAAZ,CADF,EAEGI,UAAU,IACT,mBACE,8CADF,CAHJ,EAOGmB,OAAO,IACN,mBACE,0CADF,CARJ,EAaE,MAAC,WAAD;AACE,QAAA,OAAO,EAAE,KADX;AAEE,QAAA,KAAK,EACH,mBACE;AACE,UAAA,QAAQ,MADV;AAEE,UAAA,EAAE,EAAC,aAFL;AAGE,UAAA,GAAG,EAAE,aAAA6B,KAAK;AAAA,mBAAK,MAAI,CAAC/B,WAAL,GAAmB+B,KAAxB;AAAA;AAHZ,UADF;AAHJ,QAbF,EA0BE;AAAK,QAAA,SAAS,EAAC;AAAf,SACG3C,WAAW,KAAKuD,SAAhB,GACC,MAAC,WAAD;AACE,QAAA,OAAO,EAAE,IADX;AAEE,QAAA,GAAG,EAAE,aAFP;AAGE,QAAA,IAAI,EAAED,QAHR;AAIE,QAAA,KAAK,EACH,mBACE;AACE,UAAA,QAAQ,MADV;AAEE,UAAA,EAAE,EAAC,YAFL;AAGE,UAAA,KAAK,MAHP;AAIE,UAAA,GAAG,EAAE,aAAAX,KAAK;AAAA,mBAAK,MAAI,CAACO,UAAL,GAAkBP,KAAvB;AAAA;AAJZ,UADF,CALJ;AAcE,QAAA,eAAe,EAAE,KAAKa,eAdxB;AAeE,QAAA,YAAY,EAAEhC,YAfhB;AAgBE,QAAA,YAAY,EAAE,KAAKiC,YAhBrB;AAiBE,QAAA,WAAW,EAAE,KAAKC,WAjBpB;AAkBE,QAAA,YAAY,EAAEpC;AAlBhB,QADD,GAsBC,EAvBJ,CA1BF,CADF;AAuDD;;;;EArNgB1C,KAAK,CAAC+E,S;;AAwNzB,eAAerE,IAAf","sourcesContent":["import Participant from \"./Participant\";\nimport React from \"react\";\nimport VideoCall from \"../helpers/simple-peer\";\nimport create from \"@ant-design/icons/lib/components/IconFont\";\nimport { getDisplayStream } from \"../helpers/media-access\";\n\nconst io = require(\"socket.io-client\");\nconst socket = io(process.env.reactAppSignalingServer);\n\nclass Room extends React.Component {\n  constructor() {\n    super();\n    this.state = {\n      localStream: {},\n      remoteStreamUrl: \"\",\n      streamUrl: \"\",\n      initiator: false,\n      peer: {},\n      full: false,\n      connecting: false,\n      waiting: true,\n      peerIds: [],\n      audioEnabled: false,\n      videoEnabled: true\n    };\n  }\n  videoCall = new VideoCall();\n  componentDidMount() {\n    console.log(process.env.REACT_APP_SIGNALING_SERVER);\n    const socket = io(process.env.REACT_APP_SIGNALING_SERVER);\n    const component = this;\n    this.setState({ socket });\n    const { roomId } = this.props;\n    this.getUserMedia().then(() => {\n      socket.emit(\"join\", { roomId: roomId });\n    });\n    socket.on(\"init\", () => {\n      component.setState({ initiator: true });\n    });\n    socket.on(\"ready\", () => {\n      console.log(\"c'est ok on rentre dans \" + roomId);\n      component.enter(roomId);\n    });\n    socket.on(\"desc\", data => {\n      console.log(data);\n      console.log(data.type === \"offer\" && component.state.initiator);\n      console.log(data.type === \"answer\" && !component.state.initiator);\n      if (data.type === \"offer\" && component.state.initiator) return;\n      if (data.type === \"answer\" && !component.state.initiator) return;\n      console.log(\"ok on appelle\");\n      if (component.state.connecting) component.call(data);\n    });\n    socket.on(\"disconnected\", () => {\n      console.log(\"il est parti\");\n      component.setState({ initiator: true });\n    });\n    socket.on(\"full\", () => {\n      console.log(\"c'est plein\");\n      component.setState({ full: true });\n    });\n  }\n  getUserMedia(cb) {\n    return new Promise((resolve, reject) => {\n      navigator.getUserMedia = navigator.getUserMedia =\n        navigator.getUserMedia ||\n        navigator.webkitGetUserMedia ||\n        navigator.mozGetUserMedia;\n      const op = {\n        video: {\n          width: { min: 160, ideal: 640, max: 1280 },\n          height: { min: 120, ideal: 360, max: 720 }\n        },\n        audio: true\n      };\n      navigator.getUserMedia(\n        op,\n        stream => {\n          this.setState({ streamUrl: stream, localStream: stream });\n          this.localVideo.srcObject = stream;\n          resolve();\n        },\n        () => {}\n      );\n    });\n  }\n  getDisplay() {\n    getDisplayStream().then(stream => {\n      stream.oninactive = () => {\n        this.state.peer.removeStream(this.state.localStream);\n        this.getUserMedia().then(() => {\n          this.state.peer.addStream(this.state.localStream);\n        });\n      };\n      this.setState({ streamUrl: stream, localStream: stream });\n      this.localVideo.srcObject = stream;\n      this.state.peer.addStream(stream);\n    });\n  }\n  enter = roomId => {\n    console.log(\"enter in \" + roomId);\n    this.setState({ connecting: true });\n    const peer = this.videoCall.init(\n      this.state.localStream,\n      this.state.initiator\n    );\n    this.setState({ peer });\n    this.state.peerIds.push(peer._id);\n\n    peer.on(\"signal\", data => {\n      console.log(\"signal peer\");\n      const signal = {\n        room: roomId,\n        desc: data\n      };\n      this.state.socket.emit(\"signal\", signal);\n    });\n    peer.on(\"stream\", stream => {\n      console.log(\"stream peer\");\n      this.remoteVideo.srcObject = stream;\n      this.setState({ connecting: false, waiting: false });\n    });\n    peer.on(\"error\", function(err) {\n      console.log(err);\n    });\n  };\n  call = otherId => {\n    console.log(\"callllllll\");\n    this.videoCall.connect(otherId);\n  };\n  renderFull = () => {\n    if (this.state.full) {\n      return \"The room is full\";\n    }\n  };\n\n  disableVideo = () => {\n    const videoTrack = localStream.getVideoTracks()[0];\n\n    if (localStream) {\n      videoTrack.enabled = false;\n      this.setState({ videoEnabled: false });\n    }\n  };\n\n  enableVideo = () => {\n    const videoTrack = localStream.getVideoTracks()[0];\n\n    if (localStream) {\n      videoTrack.enabled = true;\n      this.setState({ videoEnabled: true });\n    }\n  };\n\n  setAudioEnabled = bool => {\n    this.setState({ audioEnabled: bool });\n  };\n\n  render() {\n    console.log(this.state.peerIds);\n    const { username, roomId } = this.props;\n    const {\n      connecting,\n      waiting,\n      localStream,\n      audioEnabled,\n      videoEnabled\n    } = this.state;\n    return (\n      <div className=\"room\">\n        <h2>Salle: {roomId}</h2>\n        {connecting && (\n          <div>\n            <p>Establishing connection...</p>\n          </div>\n        )}\n        {waiting && (\n          <div>\n            <p>Waiting for someone...</p>\n          </div>\n        )}\n\n        <Participant\n          isLocal={false}\n          video={\n            <div>\n              <video\n                autoPlay\n                id=\"remoteVideo\"\n                ref={video => (this.remoteVideo = video)}\n              />\n            </div>\n          }\n        />\n\n        <div className=\"local-participant\">\n          {localStream !== undefined ? (\n            <Participant\n              isLocal={true}\n              key={\"fneoisfnoes\"}\n              name={username}\n              video={\n                <div>\n                  <video\n                    autoPlay\n                    id=\"localVideo\"\n                    muted\n                    ref={video => (this.localVideo = video)}\n                  />\n                </div>\n              }\n              setAudioEnabled={this.setAudioEnabled}\n              audioEnabled={audioEnabled}\n              disableVideo={this.disableVideo}\n              enableVideo={this.enableVideo}\n              videoEnabled={videoEnabled}\n            />\n          ) : (\n            \"\"\n          )}\n        </div>\n      </div>\n    );\n  }\n}\n\nexport default Room;\n"]},"metadata":{},"sourceType":"module"}